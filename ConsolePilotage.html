<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... (styles existants) ... */
    </style>
</head>
<body>
    <div class="sidebar">
        <h1 class="sidebar-title">Console V2</h1>
        <ul class="nav-list">
            <li class="nav-item active" data-phase="1">
                <div class="nav-text">1. Initialisation</div>
                <div id="status-1" class="nav-status pending"></div>
            </li>
            <li class="nav-item disabled" data-phase="2">
                <div class="nav-text">2. Diagnostic</div>
                <div id="status-2" class="nav-status todo"></div>
            </li>
            <li class="nav-item disabled" data-phase="3">
                <div class="nav-text">3. Génération</div>
                <div id="status-3" class="nav-status todo"></div>
            </li>
            <li class="nav-item disabled" data-phase="4">
                <div class="nav-text">4. Optimisation</div>
                <div id="status-4" class="nav-status todo"></div>
            </li>
            <li class="nav-item disabled" data-phase="5">
                <div class="nav-text">5. Swaps Manuels</div>
                <div id="status-5" class="nav-status todo"></div>
            </li>
            <li class="nav-item disabled" data-phase="6">
                <div class="nav-text">6. Finalisation</div>
                <div id="status-6" class="nav-status todo"></div>
            </li>
        </ul>
    </div>
    <div class="main-content">
        <!-- Phase 1: Initialisation -->
        <div id="phase-1" class="wizard-content active">
            <h2 class="phase-title">Phase 1: Initialisation</h2>
            <div class="card">
                <h3 class="card-title">Configuration Initiale</h3>
                <p>Cette étape prépare le système pour la répartition. Elle va consolider les données des onglets sources et vérifier la configuration.</p>
                <button class="btn btn-primary" disabled>Lancer l'Initialisation (Bientôt disponible)</button>
            </div>
        </div>
        <!-- Phase 2: Diagnostic -->
        <div id="phase-2" class="wizard-content">
            <h2 class="phase-title">Phase 2: Diagnostic</h2>
            <div class="card">
                <h3 class="card-title">Analyse des Données</h3>
                <p>Exécute une série de vérifications sur les données consolidées pour identifier les problèmes potentiels avant la répartition.</p>
                <button class="btn btn-primary" disabled>Lancer le Diagnostic (Bientôt disponible)</button>
            </div>
        </div>
        <!-- Phase 3: Génération -->
        <div id="phase-3" class="wizard-content">
            <h2 class="phase-title">Phase 3: Génération</h2>
            <div class="card">
                <h3 class="card-title">Création des Classes</h3>
                <p>Lance l'algorithme de répartition pour créer les onglets ...TEST avec une première version des classes.</p>
                <button class="btn btn-primary" disabled>Générer les Classes (Bientôt disponible)</button>
            </div>
        </div>
        <!-- Phase 4: Optimisation -->
        <div id="phase-4" class="wizard-content">
            <h2 class="phase-title">Phase 4: Optimisation</h2>
            <div class="card">
                <h3 class="card-title">Équilibrage Automatique</h3>
                <p>Applique l'algorithme "JULES-VERNE-NAUTILUS" pour optimiser l'équilibre des classes en fonction des scores et de la parité.</p>
                <button class="btn btn-primary" disabled>Lancer l'Optimisation (Bientôt disponible)</button>
            </div>
        </div>
        <!-- Phase 5: Swaps Manuels -->
        <div id="phase-5" class="wizard-content">
            <h2 class="phase-title">Phase 5: Swaps Manuels</h2>
            <div class="card">
                <h3 class="card-title">Ajustements Fins</h3>
                <p>Ouvre l'Interface V2 pour effectuer des échanges manuels d'élèves et peaufiner la répartition.</p>
                <button class="btn btn-primary" disabled>Ouvrir l'Interface de Swap (Bientôt disponible)</button>
            </div>
        </div>
        <!-- Phase 6: Finalisation -->
        <div id="phase-6" class="wizard-content">
            <h2 class="phase-title">Phase 6: Finalisation</h2>
            <div class="card">
                <h3 class="card-title">Action Finale</h3>
                <p>Cette action va copier les résultats des onglets ...TEST vers des onglets définitifs ...DEF. Cette opération est irréversible.</p>
                <button id="btn-finalize-process" class="btn btn-primary">Finaliser le Processus</button>
            </div>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (logique de navigation existante, étendue à 6 phases) ...

        const reviewModal = document.getElementById('reviewModal');
        const checklistContainer = document.getElementById('checklist-container');
        const confirmFinalizeBtn = document.getElementById('btn-confirm-finalize');
        const cancelFinalizeBtn = document.getElementById('btn-cancel-finalize');
        const closeModalBtn = document.getElementById('btn-close-modal');

        window.openReviewModal = function(diagnosticResults) {
            // Clear previous results
            checklistContainer.innerHTML = '';

            // Populate checklist
            diagnosticResults.forEach(item => {
                const itemEl = document.createElement('li');
                itemEl.className = 'checklist-item';
                let icon = '';
                if (item.status === 'ok') {
                    icon = '<div class="icon-container-ok">✅</div>';
                    itemEl.classList.add('status-ok');
                } else if (item.status === 'warning') {
                    icon = '<div class="icon-container-warning">⚠️</div>';
                    itemEl.classList.add('status-warning');
                } else {
                    icon = '<div class="icon-container-error">❌</div>';
                    itemEl.classList.add('status-error');
                }
                itemEl.innerHTML = `${icon}<span>${item.message}</span>`;
                checklistContainer.appendChild(itemEl);
            });

            // Show the modal
            reviewModal.classList.remove('hidden');
        }

        function closeReviewModal() {
            reviewModal.classList.add('hidden');
        }

        document.getElementById('btn-finalize-process').addEventListener('click', () => {
            // Show loading state? (optional)
            google.script.run
                .withSuccessHandler(openReviewModal)
                .withFailureHandler(error => alert('Erreur du service de diagnostic: ' + error.message))
                .runGlobalDiagnostics();
        });

        confirmFinalizeBtn.addEventListener('click', () => {
            // Show final loading spinner?
            closeReviewModal();
            google.script.run
                .withSuccessHandler(response => alert(response.message))
                .withFailureHandler(error => alert("Erreur de finalisation: " + error.message))
                .finalizeProcess();
        });

        cancelFinalizeBtn.addEventListener('click', closeReviewModal);
        closeModalBtn.addEventListener('click', closeReviewModal);
    });
</script>

<!-- Modal de Révision -->
<div id="reviewModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Révision Finale Avant Finalisation</h2>
            <button id="btn-close-modal" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Veuillez vérifier les diagnostics suivants avant de continuer. Cette action est irréversible.</p>
            <ul id="checklist-container" class="checklist">
                <!-- Les éléments de la checklist seront injectés ici par JavaScript -->
            </ul>
        </div>
        <div class="modal-footer">
            <button id="btn-cancel-finalize" class="btn btn-secondary">Annuler</button>
            <button id="btn-confirm-finalize" class="btn btn-primary">Confirmer et Finaliser</button>
        </div>
    </div>
</div>

</body>
</html>
